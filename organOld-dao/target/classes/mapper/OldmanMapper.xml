<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.organOld.dao.repository.OldmanDao">

    <resultMap id="oldman" type="com.organOld.dao.entity.oldman.Oldman">
        <id property="id" column="id" />
        <result property="name" column="name"/>
        <result property="sex" column="sex" />
        <result property="birthday" column="birthday" />
        <result property="pid" column="pid" />
        <result property="address" column="address" />
        <result property="phone" column="phone" />
        <result property="census" column="census" />
        <result property="louNum" column="lou_num" />
        <result property="oldStatus" column="old_status" />
        <result property="politicalStatus" column="political_status" />
        <result property="integral" column="integral"/>
        <result property="time" column="time" />
        <result property="sqzw" column="sqzw" />
        <result property="zc" column="zc" />
        <association property="xq" javaType="com.organOld.dao.entity.oldman.Xq">
            <id property="id" column="xid"/>
            <result property="name" column="xname"/>
            <result property="jwName" column="jname"/>
            <result property="districtName" column="dname"/>
        </association>
        <collection property="labelManList" ofType="com.organOld.dao.entity.label.LabelMan">
            <id property="id" column="lmid" />
            <result property="labelName" column="label_name"/>
            <result property="isImplement" column="is_implement" />
        </collection>
    </resultMap>


    <resultMap id="exportOldman" type="com.organOld.dao.util.bean.ExportOldman">
        <id property="id" column="id" />
        <result property="name" column="name"/>
        <result property="sex" column="sex" />
        <result property="birthday" column="birthday" />
        <result property="pid" column="pid" />
        <result property="address" column="address" />
        <result property="phone" column="phone" />
        <result property="census" column="census" />
        <result property="louNum" column="lou_num" />
        <result property="oldStatus" column="old_status" />
        <result property="politicalStatus" column="political_status" />
        <result property="sqzw" column="sqzw" />
        <result property="zc" column="zc" />
        <result property="xName" column="xName"/>
        <result property="jName" column="jName"/>
        <result property="pName" column="pName"/>
        <result property="bloodType" column="blood_type"/>
        <result property="intelligence" column="intelligence" />
        <result property="eyesight" column="eyesight" />
        <result property="family" column="family"/>
        <result property="familyType" column="family_type_index"/>
        <result property="economic" column="economic"/>
        <association property="linkman" javaType="com.organOld.dao.entity.oldman.Linkman">
            <result property="name" column="lname" />
            <result property="phone" column="lphone" />
            <result property="relation" column="relation" />
        </association>
        <collection property="healthAdd" ofType="com.organOld.dao.entity.oldman.HealthAdd">
            <id property="id" column="haid" />
            <result property="type" column="type"/>
            <result property="desc" column="desc" />
        </collection>
        <collection property="healthSelect" ofType="com.organOld.dao.entity.oldman.HealthSelect">
            <id property="id" column="hsid" />
            <result property="firType" column="fir_type"/>
            <result property="secTypeName" column="sec_type_name" />
        </collection>
    </resultMap>




    <!--不能简单的 limit 0，10  因为有1对多的关系  会补全   一条记录当多条使用（由于某个字段有多个值）-->
    <select id="getByPage" parameterType="com.organOld.dao.util.Page" resultMap="oldman">
        SELECT o.id,o.name,o.sqzw,z.value zc,o.sex,o.birthday,c.value census,p.value political_status,o.time,o.phone,o.address,o.pid,o.lou_num,o.old_status,
        x.value xname,org.name jname,d.value dname,lo.id lmid,l.name label_name,lo.is_implement
        FROM oldman_base o left join auto_value c on o.census=c.id
        left join auto_value p on o.political_status=p.id
        left join label_oldman lo on lo.oldman_id=o.id
        left join label l on lo.label_id=l.id
        left join auto_value z on o.zc=z.id,
        auto_value x,auto_value d,organ org
        WHERE  x.id=o.xq_id AND org.id=x.parent_index AND d.id=org.district_id and o.disable=0

        <if test="length!=null and length!=0">
            and o.id in(
            select a.id from
            (select oo.id from oldman_base oo,
            auto_value x,auto_value d,organ org,oldman_family ofa,oldman_economic oe,oldman_health_base ohb
            where x.id=oo.xq_id AND org.id=x.parent_index AND d.id=org.district_id and  oo.disable=0 AND ofa.oldman_id=oo.id and oe.oldman_id=oo.id AND ohb.oldman_id=oo.id
            <if test="entity.birthdayStart!=null">
                <![CDATA[
            and DATE_FORMAT(oo.birthday,'%Y') >= DATE_FORMAT(#{entity.birthdayStart},'%Y')
            ]]>
            </if>
            <if test="entity.birthdayEnd!=null">
                <![CDATA[
            and DATE_FORMAT(oo.birthday,'%Y') <= DATE_FORMAT(#{entity.birthdayEnd},'%Y')
            ]]>
            </if>
            <if test="entity!=null and entity.id!=null and entity.id!=0">
                and oo.id=#{entity.id}
            </if>
            <if test="entity!=null and entity.organId!=null and entity.organId!=0">
                and org.id in (
                SELECT
                case o.parent
                when 0 then child.id
                else o.id
                end id
                from organ o left join organ child on child.parent=o.id
                WHERE o.id=#{entity.organId}
                )
            </if>
            <if test="entity!=null and entity.sex!=null and entity.sex!=0">
                and oo.sex=#{entity.sex}
            </if>
            <if test="entity!=null and entity.isHealth!=null and entity.isHealth.length > 0">
                and (ohb.is_mb in
                <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_sn in
                <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_ywfy in
                <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_exzl in
                <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_gz in
                <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_cj in
                <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                )
            </if>
            <if test="entity!=null and entity.family!=null and entity.family.length > 0">
                and ofa.family_index in
                <foreach collection="entity.family" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.familyType!=null and entity.familyType.length > 0">
                and ofa.family_type_index in
                <foreach collection="entity.familyType" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.intelligence!=null and entity.intelligence.length > 0">
                and ohb.intelligence in
                <foreach collection="entity.intelligence" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.eyesight!=null and entity.eyesight.length > 0">
                and ohb.eyesight in
                <foreach collection="entity.eyesight" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.economic!=null and entity.economic.length > 0">
                and oe.economic_index in
                <foreach collection="entity.economic" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.censusArray!=null and entity.censusArray.length > 0">
                and oo.census in
                <foreach collection="entity.censusArray" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.zcArray!=null and entity.zcArray.length > 0">
                and oo.zc in
                <foreach collection="entity.zcArray" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.sqzwArray!=null and entity.sqzwArray.length > 0">
                and
                <foreach collection="entity.sqzwArray" index="index" item="item" open="(" separator="or" close=")">
                    (oo.sqzw like concat('%',#{item},'%'))
                </foreach>
            </if>
            <if test="entity!=null and entity.oldStatusArray!=null and entity.oldStatusArray.length > 0">
                and oo.old_status in
                <foreach collection="entity.oldStatusArray" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.politicalStatusArray!=null and entity.politicalStatusArray.length > 0">
                and oo.political_status in
                <foreach collection="entity.politicalStatusArray" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.jw!=null and entity.jw.length > 0">
                and org.id in
                <foreach collection="entity.jw" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.district!=null and entity.district.length > 0">
                and d.id in
                <foreach collection="entity.district" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="entity!=null and entity.search!=null and entity.search!=''">
                and (oo.pid LIKE  concat('%',#{entity.search},'%') OR oo.address LIKE  concat('%',#{entity.search},'%') OR oo.name LIKE  concat('%',#{entity.search},'%')
                OR oo.phone LIKE  concat('%',#{entity.search},'%'))
            </if>
             limit #{start},#{length} ) as a
            )
        </if>

    </select>

    <select id="getSizeByPage" parameterType="com.organOld.dao.util.Page" resultType="java.lang.Long">
        SELECT count(1)
        FROM oldman_base o left join auto_value c on o.census=c.id
        left join auto_value p on o.political_status=p.id left join auto_value z on o.zc=z.id,
        auto_value x,auto_value d,organ org,oldman_family ofa,oldman_economic oe,oldman_health_base ohb
        WHERE  x.id=o.xq_id AND org.id=x.parent_index AND d.id=org.district_id and ofa.oldman_id=o.id and oe.oldman_id=o.id AND ohb.oldman_id=o.id and o.disable=0
        <if test="entity.birthdayStart!=null">
            <![CDATA[
            and DATE_FORMAT(o.birthday,'%Y') >= DATE_FORMAT(#{entity.birthdayStart},'%Y')
            ]]>
        </if>
        <if test="entity.birthdayEnd!=null">
            <![CDATA[
            and DATE_FORMAT(o.birthday,'%Y') <= DATE_FORMAT(#{entity.birthdayEnd},'%Y')
            ]]>
        </if>
        <if test="entity!=null and entity.id!=null and entity.id!=0">
            and o.id=#{entity.id}
        </if>
        <if test="entity!=null and entity.oldStatusArray!=null and entity.oldStatusArray.length > 0">
            and o.old_status in
            <foreach collection="entity.oldStatusArray" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.organId!=null and entity.organId!=0">
            and org.id in (
            SELECT
            case o.parent
            when 0 then child.id
            else o.id
            end id
            from organ o left join organ child on child.parent=o.id
            WHERE o.id=#{entity.organId}
            )
        </if>
        <if test="entity!=null and entity.sex!=null and entity.sex!=0">
            and o.sex=#{entity.sex}
        </if>
        <if test="entity!=null and entity.zcArray!=null and entity.zcArray.length > 0">
            and o.zc in
            <foreach collection="entity.zcArray" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.sqzwArray!=null and entity.sqzwArray.length > 0">
            and
            <foreach collection="entity.sqzwArray" index="index" item="item" open="(" separator="or" close=")">
                (o.sqzw like concat('%',#{item},'%'))
            </foreach>
        </if>
        <if test="entity!=null and entity.isHealth!=null and entity.isHealth.length > 0">
            and (ohb.is_mb in
            <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
            or ohb.is_sn in
            <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
            or ohb.is_ywfy in
            <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
            or ohb.is_exzl in
            <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
            or ohb.is_gz in
            <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
            or ohb.is_cj in
            <foreach collection="entity.isHealth" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
            )
        </if>
        <if test="entity!=null and entity.family!=null and entity.family.length > 0">
            and ofa.family_index in
            <foreach collection="entity.family" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.familyType!=null and entity.familyType.length > 0">
            and ofa.family_type_index in
            <foreach collection="entity.familyType" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.intelligence!=null and entity.intelligence.length > 0">
            and ohb.intelligence in
            <foreach collection="entity.intelligence" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.eyesight!=null and entity.eyesight.length > 0">
            and ohb.eyesight in
            <foreach collection="entity.eyesight" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.economic!=null and entity.economic.length > 0">
            and oe.economic_index in
            <foreach collection="entity.economic" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.censusArray!=null and entity.censusArray.length > 0">
            and o.census in
            <foreach collection="entity.censusArray" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.politicalStatusArray!=null and entity.politicalStatusArray.length > 0">
            and o.political_status in
            <foreach collection="entity.politicalStatusArray" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.jw!=null and entity.jw.length > 0">
            and org.id in
            <foreach collection="entity.jw" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.district!=null and entity.district.length > 0">
            and d.id in
            <foreach collection="entity.district" index="index" item="item" open="(" separator="," close=")">
                ${item}
            </foreach>
        </if>
        <if test="entity!=null and entity.search!=null and entity.search!=''">
            and (o.pid LIKE  concat('%',#{entity.search},'%') OR o.address LIKE  concat('%',#{entity.search},'%') OR o.name LIKE  concat('%',#{entity.search},'%')
            OR o.phone LIKE  concat('%',#{entity.search},'%'))
        </if>

    </select>

    <delete id="delById">
        DELETE FROM oldman_base WHERE id=#{id}
    </delete>

    <insert id="save" parameterType="com.organOld.dao.entity.oldman.Oldman" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO oldman_base(name,sex,birthday,pid,address,xq_id,census,political_status,phone,lou_num,floor,disable,zc,sqzw)
        VALUE (#{name},#{sex},#{birthday},#{pid},#{address},#{xqId},#{census},#{politicalStatus},#{phone},#{louNum},#{floor},0,#{zc},#{sqzw})
    </insert>



    <update id="updateKeyOldman">
        UPDATE oldman_base
        SET
        goal= CASE id
            <foreach collection="list" index="index" item="item" open="" separator=" " close="">
                WHEN ${item.id} THEN #{item.goal}
            </foreach>
        END,
        key_status= CASE id
            <foreach collection="list" index="index" item="item" open="" separator=" " close="">
                WHEN ${item.id} THEN #{item.keyStatus}
            </foreach>
        END
        WHERE id in
            <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
                ${item.id}
            </foreach>
    </update>

    <update id="updateKeyOldmanFuture">
        UPDATE oldman_base
        SET
        future_goal= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.goal}
        </foreach>
        END,
        future_key_status= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.keyStatus}
        </foreach>
        END
        WHERE id in
        <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
            ${item.id}
        </foreach>
    </update>

    <select id="getMaxId" resultType="java.lang.Long">
        select MAX(id) FROM oldman_base
    </select>


    <select id="getIdByPid" resultType="java.lang.Integer">
        SELECT id FROM oldman_base WHERE pid=#{pid}
    </select>

    <update id="updateById" parameterType="com.organOld.dao.entity.oldman.Oldman">
        UPDATE oldman_base
        set name=#{name},birthday=#{birthday},sex=#{sex},pid=#{pid},address=#{address},census=#{census},political_status=#{politicalStatus},
        phone=#{phone},xq_id=#{xqId},lou_num=#{louNum},floor=#{floor},zc=#{zc},sqzw=#{sqzw}
        where id=#{id}
    </update>


    <update id="updateByIds" parameterType="java.util.List">
        update oldman_base
        SET disable=0,
        name= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.name}
        </foreach>
        ELSE name
        END,
        sex= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.sex}
        </foreach>
        ELSE sex
        END,
        birthday= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.birthday}
        </foreach>
        ELSE birthday
        END,
        pid= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.pid}
        </foreach>
        END,
        address= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.address}
        </foreach>
        ELSE address
        END,
        xq_id= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.xqId}
        </foreach>
        ELSE xq_id
        END,
        census= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.census}
        </foreach>
        ELSE census
        END,
        zc= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.zc}
        </foreach>
        ELSE zc
        END,
        sqzw= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.sqzw}
        </foreach>
        ELSE sqzw
        END,
        political_status= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.politicalStatus}
        </foreach>
        ELSE political_status
        END,
        phone= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.phone}
        </foreach>
        ELSE phone
        END,
        lou_num= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.louNum}
        </foreach>
        ELSE lou_num
        END,
        floor= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.floor}
        </foreach>
        ELSE floor
        END
        where id in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item.id,jdbcType=BIGINT}
        </foreach>
    </update>


    <update id="setDisabled">
        UPDATE oldman_base o,auto_value x,organ org
        SET o.disable=1
        WHERE o.id NOT in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        <if test="organId!=null and organId!=0">
            and x.id=o.xq_id AND org.id=x.parent_index AND org.id=#{organId}
        </if>
        and o.disable=0
    </update>

    <update id="updateProp">
        UPDATE oldman_base
        SET ${prop}=#{value}
        WHERE id=#{id}
    </update>

    <update id="updateProps">
        UPDATE oldman_base
        SET ${prop}=#{value}
        WHERE id in
        <foreach collection="ids" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </update>

    <select id="getIntegralByOldmanId" resultMap="oldman">
        SELECT name,integral FROM oldman_base WHERE id=#{oldmanId}
    </select>

    <update id="updateOrganExceLImportByIds">
        update oldman_base
        SET
        old_status= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN ${item.oldStatus}
        </foreach>
        else old_status
        END,
        is_handle= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN ${item.isHandle}
        </foreach>
        else is_handle
        END
    </update>

    <select id="getIntegralByPage" parameterType="com.organOld.dao.util.Page" resultMap="oldman">
        select o.id,o.name,o.integral
        FROM oldman_base o,organ org,auto_value x
        WHERE o.disable=0 and x.id=o.xq_id AND org.id=x.parent_index
        <if test="entity!=null and entity.organId!=null and entity.organId!=0">
            and org.id in (
            SELECT
            case o.parent
            when 0 then child.id
            else o.id
            end id
            from organ o left join organ child on child.parent=o.id
            WHERE o.id=#{entity.organId}
            )
        </if>
        <if test="entity!=null and entity.search!=null and entity.search!=''">
            and (o.name LIKE  concat('%',#{entity.search},'%')
            OR o.id=#{entity.search})
        </if>
        <if test="sortType!=null and sortType!=''">
            ORDER BY ${sortType}
        </if>
        <if test="sort!=null and sort!=''">
            ${sort}
        </if>
        <if test="length!=null and length!=0">
            limit #{start},#{length}
        </if>
    </select>


    <select id="getIntegralSizeByPage" parameterType="com.organOld.dao.util.Page" resultType="java.lang.Long">
        select count(1)
        FROM oldman_base o,organ org,auto_value x
        WHERE o.disable=0 and x.id=o.xq_id AND org.id=x.parent_index
        <if test="entity!=null and entity.organId!=null and entity.organId!=0">
            and org.id in (
            SELECT
            case o.parent
            when 0 then child.id
            else o.id
            end id
            from organ o left join organ child on child.parent=o.id
            WHERE o.id=#{entity.organId}
            )
        </if>
        <if test="entity!=null and entity.search!=null and entity.search!=''">
            and (o.name LIKE  concat('%',#{entity.search},'%')
            OR o.id=#{entity.search})
        </if>
    </select>

    <update id="addInregral">
        UPDATE oldman_base
        set integral = integral+${integral}
        WHERE id=#{oldmanId}
    </update>

    <select id="getById" resultType="com.organOld.dao.entity.oldman.Oldman">
        SELECT * from oldman_base where id=#{id}
    </select>


    <select id="getByJwId" resultType="com.organOld.dao.entity.oldman.Oldman">
        SELECT o.id,o.name,o.pid,o.old_status,o.is_handle FROM oldman_base o
        <if test="jwId!=null and jwId!=0">
            ,auto_value x,organ org
            where o.xq_id=x.id and x.parent_index=org.id and org.id=#{jwId}
        </if>
    </select>



    <select id="getAll" parameterType="com.organOld.dao.entity.oldman.Oldman" resultMap="exportOldman">
        SELECT o.id,o.name,o.sqzw,z.value zc,o.sex,o.birthday,c.value census,p.value political_status,o.phone,o.address,o.pid,o.lou_num,o.old_status,
        x.value xName,org.name jName,d.value pName,f.value family,ae.value economic,l.name lname,l.phone lphone,l.relation,ofa.family_type_index,
        ohb.blood_type,e.value eyesight,i.value intelligence,ha.type,ha.desc,hs.fir_type,hs.sec_type_name,ha.id haid,hs.id hsid
        FROM oldman_base o left join auto_value c on o.census=c.id
        left join auto_value p on o.political_status=p.id
        left join auto_value z on o.zc=z.id
        left JOIN linkman l on l.oldman_id=o.id,
        auto_value x,auto_value d,organ org,
        oldman_family ofa left join auto_value f on f.id=ofa.family_index,
        oldman_economic oe left join auto_value ae on ae.id=oe.economic_index,
        oldman_health_base ohb  LEFT JOIN health_add ha ON ha.oldman_id=ohb.oldman_id
        LEFT JOIN health_select_oldman hso on hso.oldman_id=ohb.oldman_id left join health_select hs on hso.health_select_id=hs.id
        left join auto_value e on e.id=ohb.eyesight left join auto_value i on i.id=ohb.intelligence
        WHERE  x.id=o.xq_id AND org.id=x.parent_index AND d.id=org.district_id and o.disable=0
        AND ohb.oldman_id=o.id and ofa.oldman_id=o.id and oe.oldman_id=o.id
        <if test="birthdayStart!=null">
                <![CDATA[
            and DATE_FORMAT(o.birthday,'%Y') >= DATE_FORMAT(#{birthdayStart},'%Y')
            ]]>
       </if>
        <if test="birthdayEnd!=null">
                <![CDATA[
            and DATE_FORMAT(o.birthday,'%Y') <= DATE_FORMAT(#{birthdayEnd},'%Y')
            ]]>
        </if>
           <if test="id!=null and id!=0">
                and o.id=#{id}
          </if>
           <if test="organId!=null and organId!=0">
                and org.id in (
                SELECT
                case o.parent
                when 0 then child.id
                else o.id
                end id
                from organ o left join organ child on child.parent=o.id
                WHERE o.id=#{organId}
                )
            </if>
            <if test="sex!=null and sex!=0">
                and o.sex=#{sex}
            </if>
            <if test="isHealth!=null and isHealth.length > 0">
                and (ohb.is_mb in
                <foreach collection="isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_sn in
                <foreach collection="isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_ywfy in
                <foreach collection="isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_exzl in
                <foreach collection="isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_gz in
                <foreach collection="isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                or ohb.is_cj in
                <foreach collection="isHealth" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
                )
            </if>
            <if test="family!=null and family.length > 0">
                and ofa.family_index in
                <foreach collection="family" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="familyType!=null and familyType.length > 0">
                and ofa.family_type_index in
                <foreach collection="familyType" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="intelligence!=null and intelligence.length > 0">
                and ohb.intelligence in
                <foreach collection="intelligence" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="eyesight!=null and eyesight.length > 0">
                and ohb.eyesight in
                <foreach collection="eyesight" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="economic!=null and economic.length > 0">
                and oe.economic_index in
                <foreach collection="economic" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="censusArray!=null and censusArray.length > 0">
                and o.census in
                <foreach collection="censusArray" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="zcArray!=null and zcArray.length > 0">
                and o.zc in
                <foreach collection="zcArray" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="sqzwArray!=null and sqzwArray.length > 0">
                and
                <foreach collection="sqzwArray" index="index" item="item" open="(" separator="or" close=")">
                    (o.sqzw like concat('%',#{item},'%'))
                </foreach>
            </if>
            <if test="oldStatusArray!=null and oldStatusArray.length > 0">
                and o.old_status in
                <foreach collection="oldStatusArray" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="politicalStatusArray!=null and politicalStatusArray.length > 0">
                and o.political_status in
                <foreach collection="politicalStatusArray" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="jw!=null and jw.length > 0">
                and org.id in
                <foreach collection="jw" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="district!=null and district.length > 0">
                and d.id in
                <foreach collection="district" index="index" item="item" open="(" separator="," close=")">
                    ${item}
                </foreach>
            </if>
            <if test="search!=null and search!=''">
                and (o.pid LIKE  concat('%',#{search},'%') OR o.address LIKE  concat('%',#{search},'%') OR o.name LIKE  concat('%',#{search},'%')
                OR o.phone LIKE  concat('%',#{search},'%'))
            </if>

    </select>
</mapper>
