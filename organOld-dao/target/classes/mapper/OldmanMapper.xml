<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.organOld.dao.repository.OldmanDao">

    <resultMap id="oldman" type="com.organOld.dao.entity.oldman.Oldman">
        <id property="id" column="id" />
        <result property="name" column="name"/>
        <result property="sex" column="sex" />
        <result property="birthday" column="birthday" />
        <result property="pid" column="pid" />
        <result property="address" column="address" />
        <result property="phone" column="phone" />
        <result property="census" column="census" />
        <result property="louNum" column="lou_num" />
        <result property="politicalStatus" column="political_status" />
        <result property="time" column="time" />
        <association property="xq" javaType="com.organOld.dao.entity.oldman.Xq">
            <id property="id" column="xid"/>
            <result property="name" column="xname"/>
            <result property="jwName" column="jname"/>
            <result property="districtName" column="dname"/>
        </association>
    </resultMap>

    <select id="getByPage" parameterType="com.organOld.dao.util.Page" resultMap="oldman">
        SELECT o.id,o.name,o.sex,o.birthday,c.value census,p.value political_status,o.time,o.phone,o.address,o.pid,o.lou_num,x.value xname,org.name jname,d.value dname
        FROM oldman_base o left join auto_value c on o.census=c.id
        left join auto_value p on o.political_status=p.id,
        auto_value x,auto_value d,organ org
        WHERE  x.id=o.xq_id AND org.id=x.parent_index AND d.id=org.district_id
        <if test="entity!=null and entity.id!=null and entity.id!=0">
            and o.id=#{entity.id}
        </if>
        <if test="entity!=null and entity.organId!=null and entity.organId!=0">
            and org.id=#{entity.organId}
        </if>
        <if test="entity!=null and entity.sex!=null and entity.sex!=0">
            and o.sex=#{entity.sex}
        </if>
        <if test="entity!=null and entity.census!=null and entity.census!=0">
            and o.census=#{entity.census}
        </if>
        <if test="entity!=null and entity.politicalStatus!=null and entity.politicalStatuss!=''">
            and o.political_status=#{entity.politicalStatus}
        </if>
        <if test="entity!=null and entity.search!=null and entity.search!=''">
            and (o.pid LIKE  concat('%',#{entity.search},'%') OR o.address LIKE  concat('%',#{entity.search},'%') OR o.name LIKE  concat('%',#{entity.search},'%')
            OR o.phone LIKE  concat('%',#{entity.search},'%'))
        </if>

        <if test="sortType!=null and sortType!=''">
            ORDER BY ${sortType}
        </if>
        <if test="sort!=null and sort!=''">
            ${sort}
        </if>
        <if test="length!=null and length!=0">
            limit #{start},#{length}
        </if>
    </select>

    <select id="getSizeByPage" parameterType="com.organOld.dao.util.Page" resultType="java.lang.Long">
        SELECT count(1)
        FROM oldman_base o,auto_value x,organ org
        WHERE x.id=o.xq_id AND org.id=x.parent_index
        <if test="entity!=null and entity.id!=null and entity.id!=0">
            and id=#{entity.id}
        </if>
        <if test="entity!=null and entity.organId!=null and entity.organId!=0">
            and org.id=#{entity.organId}
        </if>
        <if test="entity!=null and entity.sex!=null and entity.sex!=0">
            and sex=#{entity.sex}
        </if>
        <if test="entity!=null and entity.census!=null and entity.census!=0">
            and census=#{entity.census}
        </if>
        <if test="entity!=null and entity.politicalStatus!=null and entity.politicalStatuss!=''">
            and political_status=#{entity.politicalStatus}
        </if>
        <if test="entity!=null and entity.search!=null and entity.search!=''">
            and (pid LIKE  concat('%',#{entity.search},'%') OR address LIKE  concat('%',#{entity.search},'%') OR name LIKE  concat('%',#{entity.search},'%')
            OR phone LIKE  concat('%',#{entity.search},'%'))
        </if>
        <!--<if test="oldman!=null and oldman.birthday!=null and oldman.birthday!=''">-->
        <!--and birthday=#{oldman.birthday}-->
        <!--</if>-->

    </select>

    <delete id="delById">
        DELETE FROM oldman_base WHERE id=#{id}
    </delete>

    <insert id="save" parameterType="com.organOld.dao.entity.oldman.Oldman" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO oldman_base(name,sex,birthday,pid,address,xq_id,census,political_status,phone,lou_num,floor)
        VALUE (#{name},#{sex},#{birthday},#{pid},#{address},#{xqId},#{census},#{politicalStatus},#{phone},#{louNum},#{floor})
    </insert>

    <update id="updateById" parameterType="com.organOld.dao.entity.oldman.Oldman">
        UPDATE oldman_base
        SET name=#{name},sex=#{sex},birthday=#{birthday},pid=#{pid},address=#{address},xq_id=#{xqId},census=#{census},political_status=#{politicalStatus},
        district_id=#{districtId},phone=#{phone}
        WHERE id=#{id}
    </update>


    <update id="updateKeyOldman">
        UPDATE oldman_base
        SET
        goal= CASE id
            <foreach collection="list" index="index" item="item" open="" separator=" " close="">
                WHEN ${item.id} THEN #{item.goal}
            </foreach>
        END,
        key_status= CASE id
            <foreach collection="list" index="index" item="item" open="" separator=" " close="">
                WHEN ${item.id} THEN #{item.keyStatus}
            </foreach>
        END
        WHERE id in
            <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
                ${item.id}
            </foreach>
    </update>

    <update id="updateKeyOldmanFuture">
        UPDATE oldman_base
        SET
        future_goal= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.goal}
        </foreach>
        END,
        future_key_status= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.keyStatus}
        </foreach>
        END
        WHERE id in
        <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
            ${item.id}
        </foreach>
    </update>

    <select id="getMaxId" resultType="java.lang.Long">
        select MAX(id) FROM oldman_base
    </select>


    <select id="getIdByPid" resultType="java.lang.Integer">
        SELECT id FROM oldman_base WHERE pid=#{pid}
    </select>



    <update id="updateByIds" parameterType="java.util.List">
        update oldman_base
        SET
        name= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.name}
        </foreach>
        END,
        sex= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.sex}
        </foreach>
        END,
        birthday= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.birthday}
        </foreach>
        END,
        pid= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.pid}
        </foreach>
        END,
        address= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.address}
        </foreach>
        END,
        xq_id= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.xqId}
        </foreach>
        END,
        census= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.census}
        </foreach>
        END,
        political_status= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.politicalStatus}
        </foreach>
        END,
        phone= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.phone}
        </foreach>
        END,
        lou_num= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.louNum}
        </foreach>
        END,
        floor= CASE id
        <foreach collection="list" index="index" item="item" open="" separator=" " close="">
            WHEN ${item.id} THEN #{item.floor}
        </foreach>
        END
        where id in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item.id,jdbcType=BIGINT}
        </foreach>
    </update>


    <update id="setDisabled">
        UPDATE oldman_base o,auto_value x,organ org
        SET o.disable=1
        WHERE o.id NOT in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        <if test="organId!=null and organId!=0">
            and x.id=o.xq_id AND org.id=x.parent_index AND org.id=#{organId}
        </if>
        and o.disable=0
    </update>
</mapper>
