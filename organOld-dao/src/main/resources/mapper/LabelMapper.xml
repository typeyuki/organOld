<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.organOld.dao.repository.LabelDao">


    <resultMap id="label" type="com.organOld.dao.entity.label.Label">
        <id property="id" column="id" />
        <result property="name" column="name"/>
        <result property="content" column="content"/>
        <result property="rule" column="rule" />
        <result property="type" column="type" />
        <result property="time" column="time" />
        <association property="labelSec" javaType="com.organOld.dao.entity.label.LabelSec">
            <id property="id" column="lid" />
            <result property="secName" column="sname"/>
            <result property="firName" column="fname"/>
        </association>
        <association property="organ" javaType="com.organOld.dao.entity.organ.Organ">
            <id property="id" column="oid" />
            <result property="name" column="oname"/>
        </association>
    </resultMap>


    <resultMap id="bindOldman" type="com.organOld.dao.entity.oldman.Oldman">
        <id property="id" column="id" />
        <result property="name" column="name"/>
        <result property="sex" column="sex" />
        <result property="birthday" column="birthday" />
        <result property="pid" column="pid" />
        <result property="address" column="address" />
        <result property="phone" column="phone" />
        <result property="census" column="census" />
        <result property="louNum" column="lou_num" />
        <result property="politicalStatus" column="political_status" />
        <result property="time" column="time" />
        <association property="xq" javaType="com.organOld.dao.entity.oldman.Xq">
            <id property="id" column="xid"/>
            <result property="name" column="xname"/>
            <result property="jwName" column="jname"/>
            <result property="districtName" column="dname"/>
        </association>
    </resultMap>

    <select id="getByPage" parameterType="com.organOld.dao.util.Page" resultMap="label">
        SELECT l.id,l.name,l.content,l.rule,l.time,lt.sec_name sname,f.value fname,o.name oname
        FROM label l LEFT JOIN organ o on o.id=l.organ_id,label_type lt,auto_value f
        WHERE l.type=#{entity.type} AND l.secId=lt.id AND lt.fir_index=f.id
        <if test="entity!=null and entity.id!=null and entity.id!=0">
            and l.id=#{entity.id}
        </if>
        <if test="entity!=null and entity.jwId!=null and entity.jwId!=0">
            and l.organ_id=#{entity.jwId}
        </if>
        ORDER BY ${sortType} ${sort}
        limit #{start},#{length}

    </select>

    <select id="getSizeByPage" parameterType="com.organOld.dao.util.Page" resultType="java.lang.Long">
        SELECT count(1)
        FROM label l
        WHERE type=#{entity.type}
        <if test="entity!=null and entity.id!=null and entity.id!=0">
            and id=#{entity.id}
        </if>
        <if test="entity!=null and entity.jwId!=null and entity.jwId!=0">
            and l.organ_id=#{entity.jwId}
        </if>
    </select>


    <select id="getBindManByPage" parameterType="com.organOld.dao.util.Page" resultMap="bindOldman">
       SELECT o.id,o.name,o.sex,o.birthday,c.value census,p.value political_status,o.time,o.phone,o.address,o.pid,o.lou_num,x.value xname,org.name jname,d.value dname
        FROM oldman_base o,auto_value c,auto_value p,auto_value x,auto_value d,organ org,label_oldman lo
        WHERE o.census=c.id AND o.political_status=p.id AND x.id=o.xq_id AND org.id=x.parent_index AND d.id=org.district_id
              AND lo.label_id=#{labelId} AND o.id=lo.oldman_id
        ORDER BY ${page.sortType} ${page.sort}
        limit #{page.start},#{page.length}
    </select>


    <select id="getBindManSizeByPage" parameterType="com.organOld.dao.util.Page" resultType="java.lang.Long">
        SELECT count(1)
        FROM oldman_base o,label_oldman lo
        WHERE lo.label_id=#{labelId} AND o.id=lo.oldman_id
    </select>


    <select id="getRuleManByPage" parameterType="com.organOld.dao.util.Page" resultMap="bindOldman">
        SELECT o.id,o.name,o.sex,o.birthday,c.value census,p.value political_status,o.time,o.phone,o.address,o.pid,o.lou_num,x.value xname,org.name jname,d.value dname
        FROM oldman_base o,auto_value c,auto_value p,auto_value x,auto_value d,organ org,label_oldman lo,oldman_family oldf,
        auto_value e,oldman_economic oe,
        oldman_health_base ohb,auto_value hbi,auto_value hbe
        WHERE o.census=c.id AND o.political_status=p.id AND x.id=o.xq_id AND org.id=x.parent_index AND d.id=org.district_id
        AND e.id=oe.economic_index AND oe.oldman_id=o.id AND oldf.oldman_id=o.id
        AND ohb.oldman_id=o.id AND hbi.id=ohb.intelligence AND hbe.id=ohb.eyesight
        <if test="rule.birStart!=null">
            <![CDATA[
            and DATE_FORMAT(o.birthday,'%Y') >= DATE_FORMAT(#{rule.birStart},'%Y')
            ]]>
        </if>
        <if test="rule.birEnd!=null">
            <![CDATA[
            and DATE_FORMAT(o.birthday,'%Y') <= DATE_FORMAT(#{rule.birEnd},'%Y')
            ]]>
        </if>
        <if test="rule.sex!=null and rule.sex!=0">
            and o.sex=#{rule.sex}
        </if>
        <if test="rule.isKey!=null and rule.isKey!=0">

        </if>
        <if test="rule.censuses!=null and rule.censuses.size() > 0">
            and o.census IN
            <foreach collection="rule.censuses" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.families!=null and rule.families.size() > 0">
            and oldf.family_index IN
            <foreach collection="rule.families" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.districtIds!=null and rule.districtIds.size() > 0">
            and d.id IN
            <foreach collection="rule.districtIds" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.jwIds!=null and rule.jwIds.size() > 0">
            and org.id IN
            <foreach collection="rule.jwIds" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.politicalStatuses!=null and rule.politicalStatuses.size() > 0">
            and p.id IN
            <foreach collection="rule.politicalStatuses" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.economics!=null and rule.economics.size() > 0">
            and e.id IN
            <foreach collection="rule.economics" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.intelligences!=null and rule.intelligences.size() > 0">
            and hbi.id IN
            <foreach collection="rule.intelligences" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.eyesights!=null and rule.eyesights.size() > 0">
            and hbe.id IN
            <foreach collection="rule.eyesights" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.isHealths!=null and rule.isHealths.size() > 0">
            and (ohb.is_mb in
            <foreach collection="rule.isHealths" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR ohb.is_sn in
            <foreach collection="rule.isHealths" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR ohb.is_ywfy in
            <foreach collection="rule.isHealths" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR ohb.is_exzl in
            <foreach collection="rule.isHealths" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR ohb.is_gz in
            <foreach collection="rule.isHealths" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            OR ohb.is_cj in
            <foreach collection="rule.isHealths" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </if>
        <if test="rule.chxs!=null and rule.chxs.size() > 0">

            <foreach collection="rule.chxs" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.oldStatuses!=null and rule.oldStatuses.size() > 0">

            <foreach collection="rule.oldStatuses" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        ORDER BY ${page.sortType} ${page.sort}
        limit #{page.start},#{page.length}
    </select>


    <select id="getRuleManSizeByPage" parameterType="com.organOld.dao.util.Page" resultType="java.lang.Long">
        SELECT count(1)
        FROM oldman_base o,oldman_family oldf
        WHERE oldf.oldman_id=o.id
        <if test="rule.birStart!=null">
            <![CDATA[
            and DATE_FORMAT(o.birthday,'%Y') >= DATE_FORMAT(#{rule.birStart},'%Y')
            ]]>
        </if>
        <if test="rule.birEnd!=null">
            <![CDATA[
            and DATE_FORMAT(o.birthday,'%Y') <= DATE_FORMAT(#{rule.birEnd},'%Y')
            ]]>
        </if>
        <if test="rule.sex!=null and rule.sex!=0">
            and o.sex=#{rule.sex}
        </if>
        <if test="rule.isKey!=null and rule.isKey!=0">

        </if>
        <if test="rule.censuses!=null and rule.censuses.size() > 0">
            and o.census IN
            <foreach collection="rule.censuses" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="rule.families!=null and rule.families.size() > 0">
            and oldf.family_index IN
            <foreach collection="rule.families" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>


    <select id="getNoSelectManDataByPage" parameterType="com.organOld.dao.util.Page" resultMap="bindOldman">
        SELECT o.id,o.name,o.sex,o.birthday,c.value census,p.value political_status,o.lou_num,x.value xname,org.name jname,d.value dname
        FROM oldman_base o,auto_value c,auto_value p,auto_value x,auto_value d,organ org
        WHERE o.census=c.id AND o.political_status=p.id AND x.id=o.xq_id AND org.id=x.parent_index AND d.id=org.district_id
              AND o.id NOT IN (SELECT oldman_id FROM label_oldman WHERE label_id=#{labelId})
        ORDER BY ${page.sortType} ${page.sort}
        limit #{page.start},#{page.length}
    </select>


    <select id="getNoSelectManDataSizeByPage" parameterType="com.organOld.dao.util.Page" resultType="java.lang.Long">
        SELECT count(1)
        FROM oldman_base o
        WHERE o.id NOT IN (SELECT oldman_id FROM label_oldman WHERE label_id=#{labelId})
    </select>


    <select id="getLabelRuleByLid" resultType="com.organOld.dao.entity.label.LabelRule">
        SELECT * FROM label_rule WHERE label_id=#{labelId}
    </select>

    <update id="saveLabelRule" parameterType="com.organOld.dao.entity.label.LabelRule">
        UPDATE  label_rule
        SET age_start=#{ageStart},
        age_end=#{ageEnd},
        district_ids=#{districtIds},
        jw_ids=#{jwIds},
        sex=#{sex},
        censuses=#{censuses},
        political_statuses=#{politicalStatuses},
        is_key=#{isKey},
        economics=#{economics},
        families=#{families},
        intelligences=#{intelligences},
        eyesights=#{eyesights},
        is_healths=#{isHealths},
        chxs=#{chxs},
        old_statuses=#{oldStatuses}
        WHERE label_id=#{id}
    </update>
</mapper>
